<!DOCTYPE html><html lang="en" mode="dark" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Cortafuegos perimetral | Paloma R. García</title><meta name="generator" content="Jekyll v4.1.0" /><meta property="og:title" content="Cortafuegos perimetral" /><meta name="author" content="Paloma R. García Campón" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introducción Firewall perimetral o cortafuegos perimetral se utiliza para marcar el perímetro entre unas redes y otras. Por lo general entre una red privada y otra red o internet." /><meta property="og:description" content="Introducción Firewall perimetral o cortafuegos perimetral se utiliza para marcar el perímetro entre unas redes y otras. Por lo general entre una red privada y otra red o internet." /><link rel="canonical" href="http://localhost:4000/posts/Cortafuegos-perimetral/" /><meta property="og:url" content="http://localhost:4000/posts/Cortafuegos-perimetral/" /><meta property="og:site_name" content="Paloma R. García" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-09-11T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Cortafuegos perimetral" /><meta name="twitter:site" content="@maizymantequiya" /><meta name="twitter:creator" content="@Paloma R. García Campón" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Cortafuegos-perimetral/"},"description":"Introducción Firewall perimetral o cortafuegos perimetral se utiliza para marcar el perímetro entre unas redes y otras. Por lo general entre una red privada y otra red o internet.","@type":"BlogPosting","url":"http://localhost:4000/posts/Cortafuegos-perimetral/","headline":"Cortafuegos perimetral","dateModified":"2020-09-11T00:00:00+08:00","datePublished":"2020-09-11T00:00:00+08:00","author":{"@type":"Person","name":"Paloma R. García Campón"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" crossorigin> <script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.4.1,npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="script" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"> <script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js" async></script> <script src="/assets/js/dist/toc.min.js" async></script> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.png" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">Paloma R. García</a></div><div id="site-subtitle" class="font-italic">Un blog sobre sistemas informáticos en red</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>INICIO</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-3 mr-3 unloaded"></i> <span>CATEGORÍAS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-3 mr-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/post/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>POST</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>QUIÉN SOY</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/PalomaR88" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/maizymantequiya" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:window.open('mailto:' + ['palomagarciacampon08','gmail.com'].join('@'))" > <i class="fas fa-envelope"></i> </a> <a href="http://linkedin.com/in/paloma-garcia-24103719a/" target="_blank"> <i class="fab fa-linkedin"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Cortafuegos perimetral</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Cortafuegos perimetral</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Fri, Sep 11, 2020, 12:00 AM +0800"> Sep 11, 2020 <i class="unloaded">2020-09-11T00:00:00+08:00</i> </span> by <span class="author"> Paloma R. García Campón </span></div><div> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Sep 19, 2020, 4:19 PM +0200"> Sep 19, 2020 <i class="unloaded">2020-09-19T22:19:15+08:00</i> </span></div></div><div class="post-content"><h1 id="introducción">Introducción</h1><p>Firewall perimetral o cortafuegos perimetral se utiliza para marcar el perímetro entre unas redes y otras. Por lo general entre una red privada y otra red o internet.</p><p>El Proyecto Netfilter es la comunidad de desarrolladores de software que se dedican al framework disponible en el núcleo de Linux que permite interceptar y manipular paquetes de red, entre otras cosas. Entre los componentes más conocidos de este pryecto se encuentran nftables e iptables. Siendo IPtables la herramienta encargada de inspeccionar, modificar o eliminar paquetes de la red a partir de tablas, cadenas y reglas.</p><p>Pero, ¿qué es nftables? Podríamos decir que es lo mismo. Fue creada para sustituir a iptables y mejorar algunos problemas de rendimiento y escalabilidad que ésta tenía. Auna en una sola herramienta iptables, ip6tables, arptables, etc. y con una sintaxis más simple y compatible con la sintaxis de iptables tradicional. Y, aunque parece la misma herramienta, su arquitectura no se parece en nada puesto que no crea tablas, ni cadenas, ni reglas de manera predeterminada. Además, permite hacer múltiples acciones en una sola regla.</p><p>Podríamos decir que nftables es la herramienta definitiva, en estos momentos. Si quieres aprender sobre el uso de nftables, siento comunicarte que éste no es tu lugar, pues en este post se aportan los datos más significativos para poder crearse una idea de cómo se debe configura correctamente un cortafuego perimetral usando iptables.</p><h1 id="iptables">IPtables</h1><p>Como se ha dicho anteriormente, iptables permite definir reglas para indicar al núcleo qué hacer con los paquetes que atraviesan los interfaces de red. Estas reglas se listan formando tablas. Nerfilter posee tres tablas:</p><ul><li>FILTER: responsable del filtrado de paquetes.</li><li>NAT: establece las reglas para reescribir las direcciones y puertos en los paquetes a través de las acciones PREROUTING o POSTROUTING.</li><li>MANGLES: permite manipular los paquetes.</li></ul><p>Estas tablas poseen sus propias cadenas pero se pueden crear nuevas, relacionarlas, anidarlas, etc. para conseguir la configuración deseada.</p><p>Las opciones disponibles sobre las reglas son:</p><ul><li>-A: añadir una regla a una cadena (al final).</li><li>-I: añadir una regla a una cadena en una posición determinada.</li><li>-D: eliminar una regla a partir de la posición o coincidiendo con una serie de parámetros.</li></ul><p>Y las opciones básicas:</p><ul><li>-s: indica la dirección de origen.</li><li>-d: indica la dirección de destino.</li><li>-p: indica un protocolo.</li><li>-i: indica una interfaz de entrada.</li><li>-o: indica una interfaz de salida.</li><li>-j: inidica la acción a ejecutar sobre el paquete.</li><li>–sport: indica el puerto de origen.</li><li>–dport: inicia el puerto de destino.</li><li>–state: indica el estado del paquete (NEW, ESTABLISHED, RELATED, INVALID).</li><li>-t: indica la tabla sobre la que se quiere actuar. Si no se indica, la tabla por defecto es FILTER.</li></ul><p>Ejemplos básicos:</p><blockquote><p>Con las cuatro órdenes que se explican a continuación se limpian todas las reglas.</p></blockquote><p>Borrar las reglas de la tabla FILTER:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -F
</pre></table></code></div></div><p>Borrar las reglas de la tabla NAT:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -t nat -F
</pre></table></code></div></div><p>Poner los contadores a cero de la tabla FILTER y de la tabla NAT:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -Z
iptables -t nat -Z
</pre></table></code></div></div><h2 id="tabla-filter">Tabla FILTER</h2><p>Esta tabla posee una lista de reglas ordenadas, cada regla con una cadena que pueden ser de tres tipos:</p><ul><li>INPUT: por la que pasan todos los paquetes cuyo destino es nuestro sistema.</li><li>OUTPUT: por la que pasan todos los paquetes cuyo origen es nuestro sistema.</li><li>FORWARD: por la que pasan todos los paquetes cuyo origen o destino no es nuestro sistema pero pasan por él, para ser enrutados.</li></ul><blockquote><p>Para que nuestro sistema pueda enrutar paquetes es necesario tener activado ip_forwarding con <code class="language-plaintext highlighter-rouge">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code>. Para habilitar el ip_forwarding de forma permanente, se habilita la línea <code class="language-plaintext highlighter-rouge">net.ipv4.ip_forward=1</code> del fichero <strong>/etc/sysctl.conf</strong> y se ejecuta posteriormente <code class="language-plaintext highlighter-rouge">sysctl -p /etc/sysctl.conf</code>.</p></blockquote><p>Un punto esencial es tener en cuenta es el orden de estas reglas. Cuando un paquete alcanza una cadena, se comprueba de forma secuencial y se ejecuta la primera regla a la que se ajuste; sin tener en cuentas las posibles reglas a las que se puede ajustar posteriormente.</p><p>Las acciones más comunes son:</p><ul><li>ACCEPT: aceptar el paquete.</li><li>DROP: eliminar el paquete.</li><li>LOG: generar LOG de la conexión.</li></ul><p>Algunas de las operaciones disponibles para el manejo de las cadenas son:</p><ul><li>-L: listar las reglas de una cadena.</li><li>-P: establecer la política por defecto de una cadena.</li><li>-F: borrar todas las reglas de una cadena.</li><li>-Z: poner a cero todos los contadores (paquetes y bytes) de una cadena.</li></ul><p>Ejemplos básicos:</p><p>Permitir el tráfico para la interfaz loopback:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A INPUT -i lo -p icmp -j ACCEPT
iptables -A OUTPUT -o lo -p icmp -j ACCEPT
</pre></table></code></div></div><p>Permitir la conexión ssh desde la red 172.22.0.0/16:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A INPUT -s 172.22.0.0/16 -p tcp -m tcp --dport 22 -j ACCEPT
iptables -A OUTPUT -d 172.22.0.0/16 -p tcp -m tcp --sport 22 -j ACCEPT
</pre></table></code></div></div><p>Borrar las políticas por defecto de una cadena:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -P [INPUT | OUTPUT | FORWARD] DROP
</pre></table></code></div></div><p>Permitir ssh desde el cortafuegos a la LAN, siendo la red 192.168.100.0/24:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A OUTPUT -p tcp -o eth1 -d 192.168.100.0/24 --dport 22 -j ACCEPT
iptables -A INPUT -p tcp -i eth1 -s 192.168.100.0/24 --sport 22 -j ACCEPT
</pre></table></code></div></div><p>Permitir peticiones y respuestas con el protocolo ICMP:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A OUTPUT -o eth0 -p icmp -j ACCEPT
iptables -A INPUT -i eth0 -p icmp -j ACCEPT
</pre></table></code></div></div><p>Permitir ping a la LAN:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A OUTPUT -o eth1 -p icmp -j ACCEPT
iptables -A INPUT -i eth1 -p icmp -j ACCEPT
</pre></table></code></div></div><h3 id="reglas-forward">Reglas FORWARD</h3><p>Imaginemos un escenario compuesto por una LAN sin políticas FORWARD. En este caso los equipos que componen la LAN se encuentran incomunicados, ya que no se permite el paso de paquetes por el cortafuegos. Por lo tanto, habrá que configurar los pares de reglas, FORWARD en ambas direcciones, para ir permitiendo distintos protocolos, puertos, etc.</p><p>Ejemplos básicos:</p><p>Permitir hacer ping, protocolo ICMP, desde la LAN.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A FORWARD -o eth0 -i eth1 -s 192.168.100.0/24 -p icmp -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -d 192.168.100.0/24 -p icmp -j ACCEPT
</pre></table></code></div></div><p>Consultas y respuestas DNS, protocolo UDP por el puerto 53, desde la LAN:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A FORWARD -i eth1 -o eth0 -s 192.168.100.0/24 -p udp --dport 53 -j ACCEPT
iptables -A FORWARD -o eth1 -i eth0 -d 192.168.100.0/24 -p udp --sport 53 -j ACCEPT
</pre></table></code></div></div><p>Permitir la navegación web, por los puertos 80 y 443, desde la LAN:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>iptables -A FORWARD -i eth1 -o eth0 -s 192.168.100.0/24 -p tcp --dport 80 -j ACCEPT
iptables -A FORWARD -o eth1 -i eth0 -d 192.168.100.0/24 -p tcp --sport 80 -j ACCEPT
iptables -A FORWARD -i eth1 -o eth0 -s 192.168.100.0/24 -p tcp --dport 443 -j ACCEPT
iptables -A FORWARD -o eth1 -i eth0 -d 192.168.100.0/24 -p tcp --sport 443 -j ACCEPT
</pre></table></code></div></div><h2 id="tabla-nat">Tabla NAT</h2><h3 id="source-nat">Source NAT</h3><p>Para cambiar la dirección origen por la externa del dispositivo de NAT.Se hace como último paso antes de enviar el paquete. Se define con la cadena POSTROUTING en la tabla NAT.</p><h4 id="enmascaramiento-ip-ip-masquerade">Enmascaramiento IP (IP Masquerade)</h4><p>Cuando se realiza SNAT pero la IP origen del dispositivo es dinámica se debe comprobar la IP externa del dispositivo de NAT antes de cambiarla en el paquete. Se utiliza la opción MASQUERADE.</p><p>Ejemplos básicos:</p><p>SNAT para que los equipos de la LAN puedan acceder al exterior, siendo la red interna 192.168.100.0/24 y la interfaz externa del dispositivo de NAT la eth0, tras activar el ip_forwarding:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -j MASQUERADE
</pre></table></code></div></div><p>Permitir hacer conexiones ssh, protocolo tcp, desde los equipos de la LAN:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -t nat -I POSTROUTING -s 192.168.100.0/24 -o eth0 -p tcp --dport 22 -j MASQUERADE
</pre></table></code></div></div><p>Además, hay que permitir el tráfico de paquetes en el cortafuegos por el puerto 22:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A FORWARD -i eth1 -o eth0 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -i eth0 -o eth1 -p tcp --sport 22 -j ACCEPT
</pre></table></code></div></div><h3 id="dnat-con-iptables">DNAT con iptables</h3><p>Se utiliza para exponer un puerto de un equipo interno al exterior. Para ello se cambia la dirección destino de la externa del dispositivo a la del equipo que queremos exponer, se puede cambiar también el puerto destino, definiendo la cadena PREROUTING de la tabla NAT.</p><p>Se hace como primer paso antes de tomar la decisión de encaminamiento.</p><p>Ejemplos básicos:</p><p>Suponemos que queremos enviar las peticiones al puerto 22/tcp al equipo 192.168.100.2 de la red interna. Tras habilitar ip_forwarding:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -t nat -A PREROUTING -p tcp --dport 22 -i eth0 -j DNAT --to 192.168.100.2
</pre></table></code></div></div><p>Si fuera a un puerto diferente, por ejemplo el 2222/tcp:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -t nat -A PREROUTING -p tcp --dport 22 -i eth0 -j DNAAT --to 192.168.100.2:2222
</pre></table></code></div></div><p>Permiso de acceso a nuestro servidor web de la LAN al exterior. En un primer momento tenemos que permitir que la consulta pase por el cortafuegos:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>iptables -A FORWARD -i eth0 -o eth1 -d 192.168.100.0/24 -p tcp --dport 80 -j ACCEPT # en este caso lo correcto sería indicar la IP del servidor 
iptables -A FORWARD -i eth1 -o eth0 -s 192.168.100.0/24 -p tcp --sport 80 -j ACCEPT
</pre></table></code></div></div><p>Y necesitamos configurar una regla DNAT:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 192.168.200.10
</pre></table></code></div></div><h1 id="ejemplos-de-usos">Ejemplos de usos</h1><p>Permitir el acceso desde el esterior y desde el cortafuegos a un servidor de correo.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>iptables -A FORWARD -i eth0 -o eth1 -d 192.168.100.10/24 -p tcp --dport 25 -j ACCEPT
iptables -A FORWARD -i eth1 -o eth0 -p tcp --sport 25 -j ACCEPT
iptables -A OUTPUT -o eth1 -d 192.168.100.10/24 -p tcp --dport 25 -j ACCEPT
iptables -A INPUT -i eth1 -p tcp --sport 25 -j ACCEPT
iptables -t nat -I PREROUTING -i eth0 -p tcp --dport 25 -j DNAT --to 192.168.100.10
</pre></table></code></div></div><p>Se comprueba ejecutando un telnet al puerto 25 tcp.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>debian@router-fw:~$ telnet 192.168.100.10 25
Trying 192.168.100.10...
Connected to 192.168.100.10.
Escape character is '^]'.
220 lan.novalocal ESMTP Postfix (Debian/GNU)
</pre></table></code></div></div><p>Permitir hacer conexiones ssh desde el exterior a la LAN:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 22 -j DNAT --to 192.168.100.10
iptables -A FORWARD -i eth0 -o eth1 -p tcp --dport 22 -j ACCEPT
iptables -A FORWARD -i eth1 -o eth0 -p tcp --sport 22 -j ACCEPT
</pre></table></code></div></div><p>Modificar la regla anterior, para que al acceder desde el exterior por ssh se tenga que conectar al puerto 2222, aunque el servidor ssh esté configurado para acceder por el puerto 22:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>iptables -t nat -I PREROUTING -i eth0 -p tcp --dport 2222 -j DNAT --to 192.168.100.10:22
sudo iptables -I FORWARD -i eth0 -o eth1 -p tcp --dport 22 -j ACCEPT
sudo iptables -I FORWARD -i eth1 -o eth0 -p tcp --sport 22 -j ACCEPT
</pre></table></code></div></div><p>Permitir hacer consultas DNS sólo al servidor 192.168.202.2:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>iptables -t nat -A POSTROUTING -s 192.168.100.0/24 -o eth0 -p udp --dport 53 -j MASQUERADE
iptables -I FORWARD -i eth1 -o eth0 -d 192.168.202.2 -p udp --dport 53 -j ACCEPT
iptables -R FORWARD 2 -i eth0 -o eth1 -p udp --sport 53 -j ACCEPT
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/seguridad/'>Seguridad</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/iptables/" class="post-tag no-text-decoration" >iptables</a> <a href="/tags/firewall/" class="post-tag no-text-decoration" >firewall</a> <a href="/tags/netfilter/" class="post-tag no-text-decoration" >netfilter</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Cortafuegos perimetral - Paloma R. García&url=http://localhost:4000/posts/Cortafuegos-perimetral/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Cortafuegos perimetral - Paloma R. García&u=http://localhost:4000/posts/Cortafuegos-perimetral/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Cortafuegos perimetral - Paloma R. García&url=http://localhost:4000/posts/Cortafuegos-perimetral/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Cluster-de-Kubernetes-con-Ansible/">Cluster de Kubernetes con Ansible</a></li><li><a href="/posts/Guacamole-server/">Guacamole-server</a></li><li><a href="/posts/Cortafuegos-perimetral/">Cortafuegos perimetral</a></li><li><a href="/posts/Practica-correo-con-postfix-con-oracle/">Práctica correo con Postfix y Oracle</a></li><li><a href="/posts/Firecracker-microMV/">Introducción a MicroVM con Firecracker</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/servidor-web/">servidor web</a> <a class="post-tag" href="/tags/vagrant/">Vagrant</a> <a class="post-tag" href="/tags/apache2/">Apache2</a> <a class="post-tag" href="/tags/raid/">RAID</a> <a class="post-tag" href="/tags/oracledb/">OracleDB</a> <a class="post-tag" href="/tags/kvm/">KVM</a> <a class="post-tag" href="/tags/ansible/">Ansible</a> <a class="post-tag" href="/tags/virtualizaci%C3%B3n/">virtualización</a> <a class="post-tag" href="/tags/netfilter/">netfilter</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-3">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Firecracker-microMV/" class="btn btn-outline-primary"><p>Introducción a MicroVM con Firecracker</p></a> <a href="/posts/Practica-correo-con-postfix-con-oracle/" class="btn btn-outline-primary"><p>Práctica correo con Postfix y Oracle</p></a></div><!-- The related posts of current post. Placed in the bottom of every single post. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-4 mb-2 mb-sm-4 pb-2"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Configuracion-HTTPS-nginx/"><div class="card-body"> <span class="timeago small"> Sep 13, 2020 <i class="unloaded">2020-09-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Configurar el protocolo HTTPS en un servidor nginx</h3><div class="text-muted small"><p>HTTPS es un protocolo que permite establecer una conexión segura entre el servidor y el cliente, impidiendo que pueda ser interceptada por una persona no autorizada. En este post se va a explicar c...</p></div></div></a></div><div class="card"> <a href="/posts/practicando-con-RAID5/"><div class="card-body"> <span class="timeago small"> May 29, 2020 <i class="unloaded">2020-05-29T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Practicando con un RAID 5</h3><div class="text-muted small"><p> A continuación se van a realizar una serie de ejercicios para practicar con un RAID 5. Para ello, se va a crear un RAID 5 en una máquina de 2 GB, utilizando discos virtuales de 1 GB. CReqación ...</p></div></div></a></div><div class="card"> <a href="/posts/practicando-con-un-Raid1/"><div class="card-body"> <span class="timeago small"> May 29, 2020 <i class="unloaded">2020-05-29T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Practicando con un RAID 1</h3><div class="text-muted small"><p> En este post se van a realizar una serie de ejercicios para practicar la gestión del almacenamiento de la información. Se crea una máquina virtual con un sistema operativo Linux. Esta máquina...</p></div></div></a></div></div></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const el = document.querySelectorAll('#post-wrapper img'); const observer = lozad(el); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="http://twitter.com/maizymantequiya">Paloma R. García Campón</a>.</p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/servidor-web/">servidor web</a> <a class="post-tag" href="/tags/vagrant/">Vagrant</a> <a class="post-tag" href="/tags/apache2/">Apache2</a> <a class="post-tag" href="/tags/raid/">RAID</a> <a class="post-tag" href="/tags/oracledb/">OracleDB</a> <a class="post-tag" href="/tags/kvm/">KVM</a> <a class="post-tag" href="/tags/ansible/">Ansible</a> <a class="post-tag" href="/tags/virtualizaci%C3%B3n/">virtualización</a> <a class="post-tag" href="/tags/netfilter/">netfilter</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
